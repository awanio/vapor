---
# Vapor installation and configuration tasks

- name: Set download URL
  set_fact:
    vapor_download_url: "{{ vapor_base_url }}/{{ vapor_version }}/vapor"

# =============================================================================
# Directory Setup
# =============================================================================

- name: Create Vapor directories
  file:
    path: "{{ item.path }}"
    state: directory
    mode: "{{ item.mode }}"
    owner: "{{ vapor_user }}"
    group: "{{ vapor_group }}"
  loop:
    - { path: "{{ vapor_config_dir }}", mode: "0755" }
    - { path: "{{ vapor_log_dir }}", mode: "0755" }
    - { path: "{{ vapor_app_dir }}", mode: "0755" }
    - { path: "{{ vapor_certs_dir }}", mode: "0700" }

# =============================================================================
# OVMF/UEFI Firmware Preflight
# =============================================================================

- name: Detect secure OVMF firmware (code)
  stat:
    path: "{{ item.code }}"
  register: ovmf_secure_code_stats
  loop: "{{ vapor_ovmf_candidates_secure }}"
  changed_when: false
  when: vapor_ovmf_code_secure_path == "" or vapor_ovmf_vars_secure_path == ""

- name: Detect secure OVMF firmware (vars)
  stat:
    path: "{{ item.vars }}"
  register: ovmf_secure_vars_stats
  loop: "{{ vapor_ovmf_candidates_secure }}"
  changed_when: false
  when: vapor_ovmf_code_secure_path == "" or vapor_ovmf_vars_secure_path == ""

- name: Select secure OVMF firmware paths
  set_fact:
    vapor_ovmf_code_secure_path: "{{ item.code }}"
    vapor_ovmf_vars_secure_path: "{{ item.vars }}"
  when:
    - (vapor_ovmf_code_secure_path | default('')) == ''
    - (vapor_ovmf_vars_secure_path | default('')) == ''
    - ovmf_secure_code_stats is defined
    - ovmf_secure_vars_stats is defined
    - ovmf_secure_code_stats.results | length > loop.index0
    - ovmf_secure_vars_stats.results | length > loop.index0
    - ovmf_secure_code_stats.results[loop.index0].stat is defined
    - ovmf_secure_vars_stats.results[loop.index0].stat is defined
    - ovmf_secure_code_stats.results[loop.index0].stat.exists | default(false)
    - ovmf_secure_vars_stats.results[loop.index0].stat.exists | default(false)
  loop: "{{ vapor_ovmf_candidates_secure }}"

- name: Install OVMF firmware package (Debian family)
  apt:
    name: "{{ vapor_ovmf_packages_debian }}"
    state: present
    update_cache: true
  when:
    - ansible_os_family == "Debian"
    - (vapor_ovmf_code_secure_path | default('')) == '' or (vapor_ovmf_vars_secure_path | default('')) == ''

- name: Install OVMF firmware package (RedHat family)
  yum:
    name: "{{ vapor_ovmf_packages_redhat }}"
    state: present
  when:
    - ansible_os_family == "RedHat"
    - (vapor_ovmf_code_secure_path | default('')) == '' or (vapor_ovmf_vars_secure_path | default('')) == ''

- name: Re-check secure OVMF firmware (code)
  stat:
    path: "{{ item.code }}"
  register: ovmf_secure_code_stats
  loop: "{{ vapor_ovmf_candidates_secure }}"
  changed_when: false
  when: vapor_ovmf_code_secure_path == "" or vapor_ovmf_vars_secure_path == ""

- name: Re-check secure OVMF firmware (vars)
  stat:
    path: "{{ item.vars }}"
  register: ovmf_secure_vars_stats
  loop: "{{ vapor_ovmf_candidates_secure }}"
  changed_when: false
  when: vapor_ovmf_code_secure_path == "" or vapor_ovmf_vars_secure_path == ""

- name: Select secure OVMF firmware paths after install
  set_fact:
    vapor_ovmf_code_secure_path: "{{ item.code }}"
    vapor_ovmf_vars_secure_path: "{{ item.vars }}"
  when:
    - (vapor_ovmf_code_secure_path | default('')) == ''
    - (vapor_ovmf_vars_secure_path | default('')) == ''
    - ovmf_secure_code_stats is defined
    - ovmf_secure_vars_stats is defined
    - ovmf_secure_code_stats.results | length > loop.index0
    - ovmf_secure_vars_stats.results | length > loop.index0
    - ovmf_secure_code_stats.results[loop.index0].stat is defined
    - ovmf_secure_vars_stats.results[loop.index0].stat is defined
    - ovmf_secure_code_stats.results[loop.index0].stat.exists | default(false)
    - ovmf_secure_vars_stats.results[loop.index0].stat.exists | default(false)
  loop: "{{ vapor_ovmf_candidates_secure }}"

- name: Detect non-secure OVMF firmware (code)
  stat:
    path: "{{ item.code }}"
  register: ovmf_nonsecure_code_stats
  loop: "{{ vapor_ovmf_candidates_nonsecure }}"
  changed_when: false
  when: vapor_ovmf_code_path == "" or vapor_ovmf_vars_path == ""

- name: Detect non-secure OVMF firmware (vars)
  stat:
    path: "{{ item.vars }}"
  register: ovmf_nonsecure_vars_stats
  loop: "{{ vapor_ovmf_candidates_nonsecure }}"
  changed_when: false
  when: vapor_ovmf_code_path == "" or vapor_ovmf_vars_path == ""

- name: Select non-secure OVMF firmware paths
  set_fact:
    vapor_ovmf_code_path: "{{ item.code }}"
    vapor_ovmf_vars_path: "{{ item.vars }}"
  when:
    - (vapor_ovmf_code_path | default('')) == ''
    - (vapor_ovmf_vars_path | default('')) == ''
    - ovmf_nonsecure_code_stats is defined
    - ovmf_nonsecure_vars_stats is defined
    - ovmf_nonsecure_code_stats.results | length > loop.index0
    - ovmf_nonsecure_vars_stats.results | length > loop.index0
    - ovmf_nonsecure_code_stats.results[loop.index0].stat is defined
    - ovmf_nonsecure_vars_stats.results[loop.index0].stat is defined
    - ovmf_nonsecure_code_stats.results[loop.index0].stat.exists | default(false)
    - ovmf_nonsecure_vars_stats.results[loop.index0].stat.exists | default(false)
  loop: "{{ vapor_ovmf_candidates_nonsecure }}"

- name: Fallback non-secure OVMF paths to secure firmware when only secure is available
  set_fact:
    vapor_ovmf_code_path: "{{ vapor_ovmf_code_secure_path }}"
    vapor_ovmf_vars_path: "{{ vapor_ovmf_vars_secure_path }}"
  when:
    - (vapor_ovmf_code_path | default('')) == ''
    - (vapor_ovmf_vars_path | default('')) == ''
    - (vapor_ovmf_code_secure_path | default('')) != ''
    - (vapor_ovmf_vars_secure_path | default('')) != ''


- name: Warn if OVMF firmware not found
  debug:
    msg: |
      WARNING: OVMF/UEFI firmware was not detected on this system.
      VM creation features requiring UEFI boot will not work.
      To fix this, install OVMF manually:
        - Debian/Ubuntu: sudo apt install ovmf
        - RHEL/CentOS/Fedora: sudo dnf install edk2-ovmf
      Then re-run the installer or set vapor_ovmf_code_path and vapor_ovmf_vars_path manually.
  when:
    - (vapor_ovmf_code_path | default('')) == '' or (vapor_ovmf_vars_path | default('')) == ''
# =============================================================================
# JWT Secret Generation
# =============================================================================

- name: Check if vapor.conf exists
  stat:
    path: "{{ vapor_config_dir }}/vapor.conf"
  register: vapor_conf_stat

- name: Read existing JWT secret from config
  shell: |
    sed -n 's/^JWT_SECRET: "\(.*\)"/\1/p' {{ vapor_config_dir }}/vapor.conf
  register: existing_jwt_secret
  when: vapor_conf_stat.stat.exists
  failed_when: false
  changed_when: false

- name: Generate new JWT secret if not provided and not existing
  command: openssl rand -base64 32
  register: generated_jwt_secret
  when: >
    vapor_jwt_secret == "" and
    (not vapor_conf_stat.stat.exists or
     existing_jwt_secret.stdout | default('') == "")
  changed_when: false

- name: Set final JWT secret
  set_fact:
    vapor_jwt_secret_final: >-
      {{
        vapor_jwt_secret if vapor_jwt_secret != ""
        else (existing_jwt_secret.stdout if vapor_conf_stat.stat.exists and existing_jwt_secret.stdout | default('') != ""
        else generated_jwt_secret.stdout | default(''))
      }}

# =============================================================================
# Binary Installation
# =============================================================================

- name: Stop existing Vapor service
  systemd:
    name: vapor
    state: stopped
  failed_when: false

- name: Download Vapor binary
  get_url:
    url: "{{ vapor_download_url }}"
    dest: "{{ vapor_install_dir }}/vapor"
    mode: "0755"
    force: yes
  register: download_binary

- name: Verify binary is executable
  command: "{{ vapor_install_dir }}/vapor --version"
  changed_when: false
  failed_when: false
  register: binary_version

- name: Display installed version
  debug:
    msg: "Vapor version: {{ binary_version.stdout | default('unknown') }}"
  when: binary_version.rc == 0

# =============================================================================
# Configuration Files
# =============================================================================

- name: Create environment file
  template:
    src: environment.j2
    dest: "{{ vapor_config_dir }}/environment"
    owner: "{{ vapor_user }}"
    group: "{{ vapor_group }}"
    mode: "0600"
    force: no
  notify: restart vapor

- name: Create Vapor configuration file
  template:
    src: vapor.conf.j2
    dest: "{{ vapor_config_dir }}/vapor.conf"
    owner: "{{ vapor_user }}"
    group: "{{ vapor_group }}"
    mode: "0600"
    force: no
  notify: restart vapor

- name: Display TLS status
  debug:
    msg: "TLS/HTTPS is {{ 'ENABLED' if vapor_tls_enabled else 'DISABLED' }} - Self-signed certificates will be auto-generated on first start"

# =============================================================================
# Systemd Service
# =============================================================================

- name: Create systemd service
  template:
    src: vapor.service.j2
    dest: /etc/systemd/system/vapor.service
    owner: root
    group: root
    mode: "0644"
  register: vapor_unit
  notify: restart vapor

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes
  when: vapor_unit.changed

- name: Enable and start Vapor service
  systemd:
    name: vapor
    state: started
    enabled: yes

- name: Wait for Vapor to start
  wait_for:
    port: "{{ vapor_port }}"
    host: "127.0.0.1"
    delay: 2
    timeout: 30
  register: vapor_started
  failed_when: false

- name: Check Vapor service status
  systemd:
    name: vapor
  register: vapor_service_status

# =============================================================================
# Installation Summary
# =============================================================================

- name: Display installation summary
  debug:
    msg: |
      ============================================
      Vapor Installation Complete!
      ============================================
      Version:       {{ vapor_version }}
      Binary:        {{ vapor_install_dir }}/vapor
      Config:        {{ vapor_config_dir }}/vapor.conf
      App Directory: {{ vapor_app_dir }}
      Log Directory: {{ vapor_log_dir }}
      Certs:         {{ vapor_certs_dir }}
      
      Service Status: {{ vapor_service_status.status.ActiveState | default('unknown') }}
      TLS/HTTPS:      {{ 'Enabled' if vapor_tls_enabled else 'Disabled' }}
      
      Access: {{ 'https' if vapor_tls_enabled else 'http' }}://{{ ansible_default_ipv4.address | default('localhost') }}:{{ vapor_port }}
      
      Useful Commands:
        View logs:     journalctl -u vapor -f
        Status:        systemctl status vapor
        Restart:       systemctl restart vapor
      ============================================
